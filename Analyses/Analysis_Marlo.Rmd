---
title: "ATUS Clustering"
author: "Joe Marlo"
date: "`r format(Sys.time(), '%B %d %Y')`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

```{r include=FALSE}
get_cluster_polys <- function(df, x, y, cluster){
  # function returns polygons to draw around plot
  # usage: ggplot() + geom_polygon(data = hulls) +
  # cluster must be a string
  
  find_hull <- function(df) df[chull(df$PC1, df$PC2), ]
  hulls <- plyr::ddply(df, cluster, find_hull)
  
  return(hulls)
}
```


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(pander)
library(mclust)
library(NbClust)
options(mc.cores = parallel::detectCores())
set.seed(44)
theme_set(theme_minimal())

atus_long <- read_tsv('Data/atus.tsv')
demographics <- read_tsv('Data/demographic.tsv')
demographics <- demographics %>% 
  mutate(has_child = n_child > 0) %>% 
  select(-c('age_youngest', 'n_child', 'state'))
```


# EDA

Only contains weekend observations

```{r}
# description of the data
atus_long %>% 
  group_by(description) %>% 
  summarize(Mean = mean(value),
            part_rate = mean(value > 0)) %>% 
  arrange(desc(Mean)) %>% 
  mutate(Type = 'Continuous') %>% 
  janitor::adorn_totals() %>% 
  mutate(Mean = round(Mean, 0),
         part_rate = round(part_rate, 2),
         part_rate = ifelse(part_rate == 6.34, '-', part_rate)) %>% 
  select(Activity = description, Type, Mean, 'Participation rate' = part_rate) %>% 
  pander::pander(justify = c("left", "left", 'right', 'right'))
```

```{r}
# plot of demographic data
demographics %>% 
  select(-c('ID', 'survey_weight')) %>%
  mutate_all(as.character) %>% 
  pivot_longer(cols = everything()) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(stat = 'count') +
  facet_wrap(~ name, scales = 'free') +
  labs(title = 'Demographics', 
       x = NULL,
       y = NULL)
```

```{r}
# distance between categories
atus_long %>% 
  pivot_wider(values_from = value, names_from = description) %>% 
  select(-ID) %>% 
  as.matrix() %>% 
  t() %>% 
  dist() %>% 
  factoextra::fviz_dist(gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
```


## EDA

```{r} 
# check for NAs
dim(na.omit(atus_long)) == dim(atus_long)

# look at the data
atus_long %>% 
  ggplot(aes(x = value)) +
  geom_density() +
  facet_wrap(~description, scales = "free") + 
  labs(title = 'Feature densities (un-transformed)', 
       x = NULL,
       y = NULL)
```

## Transformations

```{r}
# log transform the data
cats_to_cube <- unique(atus_long$description)[
  !(unique(atus_long$description) %in% c('Socializing, Relaxing, and Leisure', 'Sleep'))]
atus_cube_root <- atus_long %>%
  filter(description %in% cats_to_cube) %>% 
  group_by(description) %>% 
  mutate(value = value^(1/3)) %>%
  ungroup() %>% 
  bind_rows(
    atus_long %>%
      filter(!(description %in% cats_to_cube))
  )

atus_cube_root %>%
  ggplot(aes(x = value)) +
  geom_density() +
  facet_wrap( ~ description, scales = "free") +
  labs(title = 'Feature densities (cube-root-transformed)',
       x = NULL,
       y = NULL)

# check spread of the data
atus_cube_root %>% 
  group_by(description) %>% 
  summarize(variance = var(value)) %>% 
  pander::pander(justify = c('left', 'right'), round = 2)

# scale the data ??
atus_scaled <- atus_cube_root %>% 
  group_by(description) %>% 
  mutate(value = scale(value)) %>% 
  ungroup()

# check spread of the data
atus_scaled %>% 
  group_by(description) %>% 
  summarize(variance = var(value)) %>% 
  pander::pander(justify = c('left', 'right'), round = 2)

# look at the data
atus_scaled %>% 
  ggplot(aes(x = value)) +
  geom_density() +
  facet_wrap(~description, scales = "free") + 
  labs(title = 'Feature densities (cube and scaled transformed)', 
       x = NULL)

```

```{r}
# pivot wider and turn into matrix
atus_wide <- atus_scaled %>% 
  pivot_wider(values_from = value, names_from = description) %>% 
  select(-ID) %>% 
  as.matrix()

# distance between categories
atus_wide %>%  
  t() %>% 
  dist() %>% 
  factoextra::fviz_dist(gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
```


## PCA 

```{r}
# run PCA
atus_pca <- prcomp(atus_wide)
summary(atus_pca)$importance %>% 
    pander::pander(justify = c('left', rep('right', 15)), round = 2)

pca_plot <- atus_pca$x[ , 1:3]
# rgl::plot3d(pca_plot)
```


## Resampling the data using survey weights

```{r}
# function to scale [0.1]
scale_01 <- function(x) (x - min(x)) / (max(x) - min(x))

# sample using survey weights
total_rows <- nrow(atus_wide)
sample_size <- 10000
rows_to_keep <- sample(1:total_rows, size = sample_size, prob = scale_01(demographics$survey_weight), replace = TRUE)
IDs_kept <- atus_scaled %>% 
  pivot_wider(values_from = value, names_from = description) %>% 
  select(ID) %>% 
  .[rows_to_keep,]
atus_resampled <- atus_wide[rows_to_keep,]

# pairs plot of resampled data
# as_tibble(atus_resampled) %>% 
#   GGally::ggpairs(mapping = aes(alpha = 0.2))

# correlations
corr_matrix <- cor(atus_resampled)
corr_matrix[lower.tri(corr_matrix)] %>% density() %>% plot(main = 'Density of correlations between activities')

# run PCA
atus_pca <- prcomp(atus_resampled)
summary(atus_pca)$importance %>% 
      pander::pander(justify = c('left', rep('right', 15)), round = 2)
```

```{r include=FALSE}
# memory management -------------------------------------------------------
rm(atus_scaled, atus_wide, atus_cube_root, corr_matrix, pca_plot, cats_to_cube, total_rows)
gc()
```

# Clustering
## Hierarchical cluster

```{r}
# distance matrix for features
dist_sc <- dist(atus_resampled, method = 'euclidean')

# try single, centroid, and ward (D2) linkage hier clustering
# hcl_single <- hclust(d = dist_sc, method = 'single')
# hcl_centroid <- hclust(d = dist_sc, method = 'centroid')
hcl_ward <- hclust(d = dist_sc, method = 'ward.D2')


library(dendextend)

# dev.off()
# par(mfrow = c(3, 1))
# # nearest neighbors method
# plot(hcl_single, hang = -1, main = 'Single Linkage', 
#      labels = FALSE, xlab = '', sub = '')
# # groups centroid
# plot(hcl_centroid, hang = -1, main = 'Centroid Linkage', 
#      labels = FALSE, xlab = '',  sub = '')
# Wardâ€™s minimum variance method, 
# with dissimilarities are squared before clustering
dend <- as.dendrogram(hcl_ward)
hcl_k <- 3
dend_col <- color_branches(dend, k = hcl_k)
plot(dend_col, main = paste0('Ward (D2) Linkage: K = ', hcl_k))
```

```{r}
groupings <- cutree(hcl_ward, 3)
# plot the clusters in PC space
tmp_plot_data <- atus_pca$x[, 1:2] %>% 
  as_tibble() %>% 
  mutate(Cluster = as.factor(groupings))
tmp_plot_data %>% 
  ggplot(aes(x = PC1, y = PC2, color = Cluster, fill = Cluster)) +
  geom_point(alpha = 0.3) +
  geom_polygon(data = get_cluster_polys(tmp_plot_data, x = PC1, y = PC2, cluster = 'Cluster'),
               alpha = 0.1) +
  labs(title = 'Hierarchical Ward D2 cluster solution in PC space',
       subtitle = 'Three cluster solution')
rm(tmp_plot_data)
```


### Examine the demographics through the clusters

```{r}
demographics %>% 
  right_join(bind_cols(IDs_kept, group = groupings)) %>%
  select(-c('ID', 'survey_weight')) %>%
  mutate_all(as.character) %>% 
  pivot_longer(cols = -group) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(stat = 'count') +
  facet_grid(group ~ name, scales = 'free') +
  labs(title = 'Demographics split by cluster', 
       x = NULL,
       y = NULL)
```

```{r include=FALSE}
# memory management -------------------------------------------------------
rm(dist_sc, dend, dend_col, hcl_k, dend_col, groupings, sample_size)
gc()
```


### Optimizing hierarchical cluster sizes

```{r}
# get optimal cluster sizes: c(g)
hcl_ch <- NbClust(
  data = atus_resampled,
  max.nc = 14,
  method = 'ward.D2',
  index = 'ch'
)
hcl_ch$All.index %>% plot(type = 'l', x = 2:14, main = 'Hierarchical: C(g) index', xlab = 'n clusters')

# get optimal cluster sizes: silhouette width
hcl_silhouette <- NbClust(
  data = atus_resampled,
  max.nc = 14,
  method = 'ward.D2',
  index = 'silhouette'
)
hcl_silhouette$All.index %>% plot(type = 'l', x = 2:14, main = 'Hierarchical: Silhouette', xlab = 'n clusters')


# plot the clusters in PC space
tmp_plot_data <- atus_pca$x[, 1:2] %>% 
  as_tibble() %>% 
  mutate(Cluster = as.factor(hcl_ch$Best.partition))
tmp_plot_data %>% 
  ggplot(aes(x = PC1, y = PC2, color = Cluster, fill = Cluster)) +
  geom_point(alpha = 0.3) +
  geom_polygon(data = get_cluster_polys(tmp_plot_data, x = PC1, y = PC2, cluster = 'Cluster'),
               alpha = 0.1) +
  labs(title = 'Hierarchical Ward D2 cluster solution in PC space',
       subtitle = paste0(hcl_ch$Best.nc[[1]], ' cluster solution'))
rm(tmp_plot_data)
```

### Examine the demographics through the clusters

```{r}
demographics %>% 
  right_join(bind_cols(IDs_kept, cluster =as.factor(hcl_ch$Best.partition))) %>%
  select(-c('ID', 'survey_weight')) %>%
  mutate_all(as.character) %>% 
  pivot_longer(cols = -cluster) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(stat = 'count') +
  facet_grid(cluster ~ name, scales = 'free') +
  labs(title = 'Demographics split by cluster', 
       subtitle = 'Hierarchical Ward D2 cluster solution',
       x = NULL,
       y = NULL)
```

## kmeans clustering

```{r}
# get optimal cluster sizes 
km_ch <- NbClust(
  data = atus_resampled,
  max.nc = 20,
  method = 'kmeans',
  index = 'ch'
)
km_ch$All.index %>% plot(type = 'l', x = 2:20, main = 'Kmeans: C(g) index', xlab = 'n clusters')

# get optimal cluster sizes 
km_silhouette <- NbClust(
  data = atus_resampled,
  max.nc = 20,
  method = 'kmeans',
  index = 'silhouette'
)
km_silhouette$All.index %>% plot(type = 'l', x = 2:20, main = 'Kmeans: Silhouette', xlab = 'n clusters')

# run the final kmeans algo with optimal number of clusters
km_eleven <- kmeans(x = atus_resampled,
                  centers = km_ch$Best.nc[[1]],
                  nstart = 100,
                  iter.max = 30,
                  algorithm = 'Hartigan-Wong')

# plot the clusters in PC space
tmp_plot_data <- atus_pca$x[, 1:2] %>% 
  as_tibble() %>% 
  mutate(Cluster = as.factor(km_eleven$cluster))
tmp_plot_data %>% 
  ggplot(aes(x = PC1, y = PC2, color = Cluster, fill = Cluster)) +
  geom_point(alpha = 0.3) +
  geom_polygon(data = get_cluster_polys(tmp_plot_data, x = PC1, y = PC2, cluster = 'Cluster'),
               alpha = 0.1) +
  labs(title = 'K-means cluster solution in PC space')
rm(tmp_plot_data)
```


### Examine the demographics through the clusters

```{r}
demographics %>% 
  right_join(bind_cols(IDs_kept, cluster = as.factor(km_eleven$cluster))) %>%
  select(-c('ID', 'survey_weight')) %>%
  mutate_all(as.character) %>% 
  pivot_longer(cols = -cluster) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(stat = 'count') +
  facet_grid(cluster ~ name, scales = 'free') +
  labs(title = 'Demographics split by cluster', 
       subtitle = 'K-means cluster solution',
       x = NULL,
       y = NULL)
```

### Kmeans gap statistic

```{r eval=FALSE, include=FALSE}
gc()
# takes an hour !!!!
gap_stat <- cluster::clusGap(atus_resampled, FUN = kmeans, K.max = 20, nstart = 20, B = 25, iter.max = 20)

factoextra::fviz_gap_stat(gap_stat)
```


## Model based  clustering

```{r}
# run model
mcl <- Mclust(atus_resampled)
summary(mcl)

# plot 
plot(mcl, what = "BIC")
factoextra::fviz_mclust(mcl, "classification", geom = "point", alpha = 0.3)
```


### Examine the demographics through the clusters

```{r}
demographics %>% 
  right_join(bind_cols(IDs_kept, cluster = as.factor(mcl$classification))) %>%
  select(-c('ID', 'survey_weight')) %>%
  mutate_all(as.character) %>% 
  pivot_longer(cols = -cluster) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(stat = 'count') +
  facet_grid(cluster ~ name, scales = 'free') +
  labs(title = 'Demographics split by cluster', 
       subtitle = 'Model-based cluster solution',
       x = NULL,
       y = NULL)
```
